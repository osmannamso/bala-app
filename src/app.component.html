<div class="w-full max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
  <header class="text-center mb-8">
    <h1 class="text-4xl sm:text-5xl font-bold text-sky-600 drop-shadow-sm">
      Kid's Soundboard
    </h1>
  </header>

  <main>
    @if (isLoading()) {
      <div class="flex justify-center items-center h-64">
        <div class="w-12 h-12 border-4 border-sky-200 border-t-sky-500 rounded-full animate-spin"></div>
      </div>
    } @else {
      @switch (currentView()) {
        @case ('categories') {
          <section>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 sm:gap-6">
              @for (category of categories(); track category.id) {
                <div class="relative group">
                  <button (click)="selectCategory(category)" class="aspect-square bg-white rounded-2xl shadow-lg p-3 w-full text-center transition-transform hover:scale-105 hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-sky-300">
                    <img [src]="createBlobUrl(category.picture)" alt="{{ category.name }}" class="w-full h-full object-cover rounded-xl mb-2"/>
                    <span class="block font-semibold text-slate-700 mt-2 truncate group-hover:text-sky-600">{{ category.name }}</span>
                  </button>
                  <button (click)="requestDeleteCategory($event, category)" aria-label="Delete category" class="absolute top-2 right-2 p-1.5 bg-black/40 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-500 focus:opacity-100 focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                  </button>
                </div>
              }
            </div>
            @if (categories().length === 0) {
              <p class="text-center text-slate-500 mt-8">No categories yet. Click the '+' button to create one!</p>
            }
          </section>
        }

        @case ('items') {
          <section>
            <div class="flex items-center mb-6">
              <button (click)="goHome()" class="p-2 rounded-full hover:bg-slate-200 transition-colors focus:outline-none focus:ring-2 focus:ring-slate-400">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                 </svg>
              </button>
              <h2 class="text-2xl sm:text-3xl font-bold text-slate-700 ml-4">{{ selectedCategory()?.name }}</h2>
            </div>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 sm:gap-6">
              @for (item of items(); track item.id) {
                <div class="relative group">
                  <button (click)="playItemSound(item.sound)" class="aspect-square bg-white rounded-2xl shadow-lg p-3 w-full text-center transition-transform hover:scale-105 hover:shadow-xl focus:outline-none focus:ring-4 focus:ring-sky-300">
                    <img [src]="createBlobUrl(item.picture)" alt="{{ item.name }}" class="w-full h-full object-cover rounded-xl mb-2"/>
                    <span class="block font-semibold text-slate-700 mt-2 truncate group-hover:text-sky-600">{{ item.name }}</span>
                  </button>
                   <button (click)="requestDeleteItem($event, item)" aria-label="Delete item" class="absolute top-2 right-2 p-1.5 bg-black/40 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-500 focus:opacity-100 focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                    </svg>
                  </button>
                </div>
              }
            </div>
             @if (items().length === 0) {
              <p class="text-center text-slate-500 mt-8">This category is empty. Click the '+' button to add something new!</p>
            }
          </section>
        }

        @case ('addCategory') {
          <section class="max-w-md mx-auto bg-white p-8 rounded-2xl shadow-2xl">
            <h2 class="text-2xl font-bold mb-6 text-slate-700">Add New Category</h2>
            <form (submit)="addCategory($event)" class="space-y-6">
              <div>
                <label for="categoryName" class="block text-sm font-medium text-slate-600 mb-1">Category Name</label>
                <input id="categoryName" name="name" type="text" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500"/>
              </div>
              <div>
                <label for="categoryPicture" class="block text-sm font-medium text-slate-600 mb-1">Category Picture</label>
                <input id="categoryPicture" name="picture" type="file" accept="image/*" required (change)="onFileSelected($event, 'image')" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100"/>
                @if(imagePreview()) {
                  <img [src]="imagePreview()" alt="Image preview" class="mt-4 rounded-lg h-32 w-32 object-cover"/>
                }
              </div>
              <div class="flex justify-end gap-4 pt-4">
                <button type="button" (click)="goHome()" class="px-6 py-2 rounded-lg text-slate-700 bg-slate-100 hover:bg-slate-200">Cancel</button>
                <button type="submit" class="px-6 py-2 rounded-lg text-white bg-sky-500 hover:bg-sky-600">Save</button>
              </div>
            </form>
          </section>
        }

        @case ('addItem') {
          <section class="max-w-md mx-auto bg-white p-8 rounded-2xl shadow-2xl">
             <div class="flex items-center mb-6">
               <button (click)="selectCategory(selectedCategory()!)" class="p-2 rounded-full hover:bg-slate-200 transition-colors focus:outline-none focus:ring-2 focus:ring-slate-400">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                   <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                 </svg>
              </button>
              <h2 class="text-2xl font-bold text-slate-700 ml-4">Add Item to {{ selectedCategory()?.name }}</h2>
            </div>
            <form (submit)="addItem($event)" class="space-y-6">
              <div>
                <label for="itemName" class="block text-sm font-medium text-slate-600 mb-1">Item Name</label>
                <input id="itemName" name="name" type="text" required class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500"/>
              </div>
              <div>
                <label for="itemPicture" class="block text-sm font-medium text-slate-600 mb-1">Item Picture</label>
                <input id="itemPicture" name="picture" type="file" accept="image/*" required (change)="onFileSelected($event, 'image')" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100"/>
                 @if(imagePreview()) {
                  <img [src]="imagePreview()" alt="Image preview" class="mt-4 rounded-lg h-32 w-32 object-cover"/>
                }
              </div>
              <div>
                 <label class="block text-sm font-medium text-slate-600 mb-2">Item Sound</label>
                 <div class="flex items-center gap-4">
                  @if (!isRecording()) {
                    <button type="button" (click)="startRecording()" class="flex items-center gap-2 px-4 py-2 rounded-lg text-white bg-red-500 hover:bg-red-600 disabled:bg-red-300" [disabled]="isRecording()">
                      <div class="w-3 h-3 bg-white rounded-full"></div>
                      Record
                    </button>
                  } @else {
                     <button type="button" (click)="stopRecording()" class="flex items-center gap-2 px-4 py-2 rounded-lg text-white bg-slate-600 hover:bg-slate-700">
                      <div class="w-3 h-3 bg-white rounded-sm"></div>
                      Stop
                    </button>
                  }

                   @if(isRecording()){
                      <div class="flex items-center gap-2 text-red-500">
                          <div class="w-2 h-2 bg-red-500 rounded-full animate-pulse"></div>
                          <span>Recording...</span>
                      </div>
                   }
                 </div>
                  @if (recordedSoundUrl()) {
                    <div class="mt-4">
                      <p class="text-sm font-medium text-slate-600 mb-2">Preview:</p>
                      <audio [src]="recordedSoundUrl()" controls class="w-full"></audio>
                    </div>
                  } @else if (!isRecording()) {
                     <p class="text-xs text-slate-400 mt-2">Click 'Record' to add a sound.</p>
                  }
              </div>

               <div class="flex justify-end gap-4 pt-4">
                <button type="button" (click)="selectCategory(selectedCategory()!)" class="px-6 py-2 rounded-lg text-slate-700 bg-slate-100 hover:bg-slate-200">Cancel</button>
                <button type="submit" class="px-6 py-2 rounded-lg text-white bg-sky-500 hover:bg-sky-600" [disabled]="!recordedSoundBlob() || !imageFile()">Save</button>
              </div>
            </form>
          </section>
        }
      }

      <!-- Floating Action Buttons -->
      @if (currentView() === 'categories') {
        <button (click)="showAddCategoryForm()" aria-label="Add New Category" class="fixed bottom-8 right-8 w-16 h-16 bg-sky-500 hover:bg-sky-600 text-white rounded-full shadow-lg flex items-center justify-center transition-transform hover:scale-110 focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-sky-400">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
          </svg>
        </button>
      }
      @if (currentView() === 'items') {
        <button (click)="showAddItemForm()" aria-label="Add New Item" class="fixed bottom-8 right-8 w-16 h-16 bg-green-500 hover:bg-green-600 text-white rounded-full shadow-lg flex items-center justify-center transition-transform hover:scale-110 focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-green-400">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
          </svg>
        </button>
      }
    }
  </main>

  <!-- Deletion Confirmation Modal -->
  @if (deleteConfirmation(); as confirmation) {
    <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center p-4 z-50 animate-fade-in" (click)="cancelDeletion()">
      <div class="bg-white rounded-2xl shadow-2xl p-6 sm:p-8 w-full max-w-sm" (click)="$event.stopPropagation()">
        <h3 class="text-xl font-bold text-slate-800">Confirm Deletion</h3>
        @if (confirmation.type === 'category') {
          <p class="mt-2 text-slate-600">
            Are you sure you want to delete the category
            <strong class="text-slate-900">"{{ confirmation.data.name }}"</strong>?
            <br><br>
            <span class="font-semibold text-red-600">All items inside will also be deleted.</span> This action cannot be undone.
          </p>
        } @else {
          <p class="mt-2 text-slate-600">
            Are you sure you want to delete the item
            <strong class="text-slate-900">"{{ confirmation.data.name }}"</strong>?
            This action cannot be undone.
          </p>
        }
        <div class="mt-8 flex justify-end gap-3">
          <button type="button" (click)="cancelDeletion()" class="px-5 py-2.5 rounded-lg font-semibold text-slate-700 bg-slate-100 hover:bg-slate-200 transition-colors focus:outline-none focus:ring-2 focus:ring-slate-400 focus:ring-offset-2">
            Cancel
          </button>
          <button type="button" (click)="confirmDeletion()" class="px-5 py-2.5 rounded-lg font-semibold text-white bg-red-600 hover:bg-red-700 transition-colors flex items-center gap-2 justify-center w-32 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2" [disabled]="isDeleting()">
            @if(isDeleting()) {
              <div class="w-5 h-5 border-2 border-white/50 border-t-white rounded-full animate-spin"></div>
              <span>Deleting...</span>
            } @else {
              <span>Delete</span>
            }
          </button>
        </div>
      </div>
    </div>
  }
</div>